-- This script was generated by the ERD tool in pgAdmin 4.
-- Please log an issue at https://github.com/pgadmin-org/pgadmin4/issues/new/choose if you find any bugs, including reproduction steps.
BEGIN;


CREATE TABLE IF NOT EXISTS public.comments
(
    comment_id uuid NOT NULL DEFAULT gen_random_uuid(),
    test_order_id uuid,
    test_result_id uuid,
    comment_text text COLLATE pg_catalog."default" NOT NULL,
    comment_type character varying(50) COLLATE pg_catalog."default" DEFAULT 'GENERAL'::comment_type_enum,
    created_by uuid,
    updated_by uuid,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone,
    CONSTRAINT comments_pkey PRIMARY KEY (comment_id)
);

CREATE TABLE IF NOT EXISTS public.flagging_configurations
(
    config_id uuid NOT NULL DEFAULT gen_random_uuid(),
    test_type_id uuid NOT NULL,
    rule_name character varying(200) COLLATE pg_catalog."default",
    condition_type character varying(255) COLLATE pg_catalog."default",
    min_value double precision,
    max_value double precision,
    target_value double precision,
    flag_level character varying(50) COLLATE pg_catalog."default",
    flag_color character varying(20) COLLATE pg_catalog."default",
    is_active boolean DEFAULT true,
    version_number integer DEFAULT 1,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone,
    CONSTRAINT flagging_configurations_pkey PRIMARY KEY (config_id)
);

CREATE TABLE IF NOT EXISTS public.flyway_schema_history
(
    installed_rank integer NOT NULL,
    version character varying(50) COLLATE pg_catalog."default",
    description character varying(200) COLLATE pg_catalog."default",
    type character varying(20) COLLATE pg_catalog."default" NOT NULL,
    script character varying(1000) COLLATE pg_catalog."default" NOT NULL,
    checksum integer,
    installed_by character varying(100) COLLATE pg_catalog."default" NOT NULL,
    installed_on timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    execution_time integer,
    success boolean NOT NULL
);

CREATE TABLE IF NOT EXISTS public.instruments
(
    instrument_id uuid NOT NULL DEFAULT gen_random_uuid(),
    code character varying(50) COLLATE pg_catalog."default" NOT NULL,
    name character varying(200) COLLATE pg_catalog."default" NOT NULL,
    model character varying(255) COLLATE pg_catalog."default",
    manufacturer character varying(255) COLLATE pg_catalog."default",
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone,
    CONSTRAINT instruments_pkey PRIMARY KEY (instrument_id),
    CONSTRAINT instruments_code_key UNIQUE (code)
);

CREATE TABLE IF NOT EXISTS public.medical_record_access_log
(
    log_id uuid NOT NULL,
    action character varying(255) COLLATE pg_catalog."default",
    client_ip character varying(255) COLLATE pg_catalog."default",
    medical_record_id uuid,
    reason character varying(255) COLLATE pg_catalog."default",
    "timestamp" timestamp(6) without time zone,
    user_agent character varying(255) COLLATE pg_catalog."default",
    user_id uuid,
    username character varying(255) COLLATE pg_catalog."default",
    CONSTRAINT medical_record_access_log_pkey PRIMARY KEY (log_id)
);

CREATE TABLE IF NOT EXISTS public.medical_record_history
(
    history_id uuid NOT NULL,
    action character varying(255) COLLATE pg_catalog."default",
    action_at timestamp(6) without time zone,
    action_by uuid,
    medical_record_id uuid,
    snapshot jsonb,
    CONSTRAINT medical_record_history_pkey PRIMARY KEY (history_id)
);

CREATE TABLE IF NOT EXISTS public.medical_records
(
    medical_record_id uuid NOT NULL DEFAULT gen_random_uuid(),
    patient_id uuid NOT NULL,
    record_code character varying(255) COLLATE pg_catalog."default" NOT NULL,
    visit_date timestamp without time zone,
    chief_complaint character varying(255) COLLATE pg_catalog."default",
    diagnosis character varying(255) COLLATE pg_catalog."default",
    clinical_notes jsonb,
    test_order_ids jsonb,
    last_test_date timestamp without time zone,
    created_by uuid,
    updated_by uuid,
    is_deleted boolean DEFAULT false,
    deleted_at timestamp without time zone,
    deleted_by uuid,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    version bigint DEFAULT 0,
    department jsonb NOT NULL DEFAULT '[]'::jsonb,
    CONSTRAINT medical_records_pkey PRIMARY KEY (medical_record_id),
    CONSTRAINT medical_records_record_code_key UNIQUE (record_code)
);

CREATE TABLE IF NOT EXISTS public.patients
(
    patient_id uuid NOT NULL DEFAULT gen_random_uuid(),
    full_name character varying(255) COLLATE pg_catalog."default" NOT NULL,
    dob date,
    gender character varying(255) COLLATE pg_catalog."default",
    contact_number character varying(255) COLLATE pg_catalog."default",
    address character varying(255) COLLATE pg_catalog."default",
    last_test_date timestamp without time zone,
    created_by uuid,
    updated_by uuid,
    is_deleted boolean DEFAULT false,
    deleted_at timestamp without time zone,
    deleted_by uuid,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    email character varying(255) COLLATE pg_catalog."default",
    CONSTRAINT patients_pkey PRIMARY KEY (patient_id)
);

CREATE TABLE IF NOT EXISTS public.reagents
(
    reagent_id uuid NOT NULL DEFAULT gen_random_uuid(),
    name character varying(200) COLLATE pg_catalog."default" NOT NULL,
    batch_number character varying(255) COLLATE pg_catalog."default",
    expiration_date timestamp(6) without time zone,
    supplier character varying(255) COLLATE pg_catalog."default",
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone,
    CONSTRAINT reagents_pkey PRIMARY KEY (reagent_id)
);

CREATE TABLE IF NOT EXISTS public.test_order_items
(
    test_order_item_id uuid NOT NULL DEFAULT gen_random_uuid(),
    test_order_id uuid NOT NULL,
    test_type_id uuid NOT NULL,
    status character varying(50) COLLATE pg_catalog."default" DEFAULT 'PENDING'::character varying,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    flag_type character varying(255) COLLATE pg_catalog."default",
    CONSTRAINT test_order_items_pkey PRIMARY KEY (test_order_item_id)
);

CREATE TABLE IF NOT EXISTS public.test_orders
(
    test_order_id uuid NOT NULL DEFAULT gen_random_uuid(),
    order_number character varying(50) COLLATE pg_catalog."default" NOT NULL,
    medical_record_id uuid NOT NULL,
    patient_name character varying(200) COLLATE pg_catalog."default",
    age integer,
    gender character varying(10) COLLATE pg_catalog."default",
    phone_number character varying(50) COLLATE pg_catalog."default",
    email character varying(150) COLLATE pg_catalog."default",
    address text COLLATE pg_catalog."default",
    date_of_birth timestamp(6) without time zone,
    status character varying(50) COLLATE pg_catalog."default" DEFAULT 'PENDING'::character varying,
    priority character varying(50) COLLATE pg_catalog."default" DEFAULT 'NORMAL'::character varying,
    clinical_notes text COLLATE pg_catalog."default",
    medical_record_snapshot text COLLATE pg_catalog."default",
    is_deleted boolean DEFAULT false,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone,
    created_by uuid,
    updated_by uuid,
    run_at timestamp without time zone,
    run_by uuid,
    reviewed_at timestamp without time zone,
    reviewed_by uuid,
    CONSTRAINT test_orders_pkey PRIMARY KEY (test_order_id),
    CONSTRAINT test_orders_order_number_key UNIQUE (order_number)
);

CREATE TABLE IF NOT EXISTS public.test_results
(
    test_result_id uuid NOT NULL DEFAULT gen_random_uuid(),
    test_order_id uuid NOT NULL,
    test_order_item_id uuid NOT NULL,
    test_type_id uuid NOT NULL,
    instrument_id uuid,
    reagent_id uuid,
    result_value double precision,
    result_text text COLLATE pg_catalog."default",
    result_unit character varying(255) COLLATE pg_catalog."default",
    reference_range_min double precision,
    reference_range_max double precision,
    interpretation text COLLATE pg_catalog."default",
    is_flagged boolean DEFAULT false,
    flag_type character varying(50) COLLATE pg_catalog."default",
    flag_reason text COLLATE pg_catalog."default",
    quality_control_status character varying(50) COLLATE pg_catalog."default",
    error_messages text COLLATE pg_catalog."default",
    warning_messages text COLLATE pg_catalog."default",
    processed_at timestamp without time zone,
    processed_by uuid,
    reviewed_at timestamp without time zone,
    reviewed_by uuid,
    ai_reviewed_by character varying(150) COLLATE pg_catalog."default",
    version_number integer DEFAULT 1,
    CONSTRAINT test_results_pkey PRIMARY KEY (test_result_id)
);

CREATE TABLE IF NOT EXISTS public.test_type_instruments
(
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    test_type_id uuid NOT NULL,
    instrument_id uuid NOT NULL,
    CONSTRAINT test_type_instruments_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.test_type_reagents
(
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    test_type_id uuid NOT NULL,
    reagent_id uuid NOT NULL,
    CONSTRAINT test_type_reagents_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.test_types
(
    test_type_id uuid NOT NULL DEFAULT gen_random_uuid(),
    code character varying(50) COLLATE pg_catalog."default" NOT NULL,
    name character varying(200) COLLATE pg_catalog."default" NOT NULL,
    description character varying(255) COLLATE pg_catalog."default",
    category character varying(255) COLLATE pg_catalog."default",
    method character varying(255) COLLATE pg_catalog."default",
    unit character varying(255) COLLATE pg_catalog."default",
    reference_min double precision,
    reference_max double precision,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone,
    CONSTRAINT test_types_pkey PRIMARY KEY (test_type_id),
    CONSTRAINT test_types_code_key UNIQUE (code)
);

ALTER TABLE IF EXISTS public.comments
    ADD CONSTRAINT comments_test_order_id_fkey FOREIGN KEY (test_order_id)
    REFERENCES public.test_orders (test_order_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_comments_test_order
    ON public.comments(test_order_id);


ALTER TABLE IF EXISTS public.comments
    ADD CONSTRAINT comments_test_result_id_fkey FOREIGN KEY (test_result_id)
    REFERENCES public.test_results (test_result_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_comments_test_result
    ON public.comments(test_result_id);


ALTER TABLE IF EXISTS public.flagging_configurations
    ADD CONSTRAINT fk_flagconfig_testtype FOREIGN KEY (test_type_id)
    REFERENCES public.test_types (test_type_id) MATCH SIMPLE
    ON UPDATE CASCADE
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.medical_records
    ADD CONSTRAINT fk_medicalrecord_patient FOREIGN KEY (patient_id)
    REFERENCES public.patients (patient_id) MATCH SIMPLE
    ON UPDATE CASCADE
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.test_order_items
    ADD CONSTRAINT fk_testorderitem_testorder FOREIGN KEY (test_order_id)
    REFERENCES public.test_orders (test_order_id) MATCH SIMPLE
    ON UPDATE CASCADE
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.test_order_items
    ADD CONSTRAINT fk_testorderitem_testtype FOREIGN KEY (test_type_id)
    REFERENCES public.test_types (test_type_id) MATCH SIMPLE
    ON UPDATE CASCADE
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.test_orders
    ADD CONSTRAINT fk_testorder_medicalrecord FOREIGN KEY (medical_record_id)
    REFERENCES public.medical_records (medical_record_id) MATCH SIMPLE
    ON UPDATE CASCADE
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.test_results
    ADD CONSTRAINT fk_testresult_instrument FOREIGN KEY (instrument_id)
    REFERENCES public.instruments (instrument_id) MATCH SIMPLE
    ON UPDATE CASCADE
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.test_results
    ADD CONSTRAINT fk_testresult_reagent FOREIGN KEY (reagent_id)
    REFERENCES public.reagents (reagent_id) MATCH SIMPLE
    ON UPDATE CASCADE
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.test_results
    ADD CONSTRAINT fk_testresult_testorder FOREIGN KEY (test_order_id)
    REFERENCES public.test_orders (test_order_id) MATCH SIMPLE
    ON UPDATE CASCADE
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.test_results
    ADD CONSTRAINT fk_testresult_testtype FOREIGN KEY (test_type_id)
    REFERENCES public.test_types (test_type_id) MATCH SIMPLE
    ON UPDATE CASCADE
    ON DELETE SET NULL;


ALTER TABLE IF EXISTS public.test_results
    ADD CONSTRAINT fkjrlwf06278r492qyl96dkwsto FOREIGN KEY (test_order_item_id)
    REFERENCES public.test_order_items (test_order_item_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.test_type_instruments
    ADD CONSTRAINT fk_tti_instrument FOREIGN KEY (instrument_id)
    REFERENCES public.instruments (instrument_id) MATCH SIMPLE
    ON UPDATE CASCADE
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.test_type_instruments
    ADD CONSTRAINT fk_tti_testtype FOREIGN KEY (test_type_id)
    REFERENCES public.test_types (test_type_id) MATCH SIMPLE
    ON UPDATE CASCADE
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.test_type_reagents
    ADD CONSTRAINT fk_ttr_reagent FOREIGN KEY (reagent_id)
    REFERENCES public.reagents (reagent_id) MATCH SIMPLE
    ON UPDATE CASCADE
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.test_type_reagents
    ADD CONSTRAINT fk_ttr_testtype FOREIGN KEY (test_type_id)
    REFERENCES public.test_types (test_type_id) MATCH SIMPLE
    ON UPDATE CASCADE
    ON DELETE CASCADE;

END;